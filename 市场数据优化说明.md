# å¸‚åœºæ•°æ®æ˜¾ç¤ºä¼˜åŒ–å’Œ CNY/JPY æ±‡ç‡æ·»åŠ è¯´æ˜

## ğŸ“‹ æ›´æ–°æ—¥æœŸ
2026-01-29

## ğŸ¯ ä»»åŠ¡æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®Œæˆäº†ä¸¤ä¸ªæ ¸å¿ƒä»»åŠ¡ï¼š
1. **ä¼˜åŒ– MarketItem ç»„ä»¶çš„ UI æ˜¾ç¤º**ï¼šæ·»åŠ ä¸­æ–‡æ ‡ç­¾ï¼Œä¿®å¤æ ‡é¢˜é‡å¤é—®é¢˜
2. **æ·»åŠ  CNY/JPY æ±‡ç‡**ï¼šå®ç°äººæ°‘å¸å¯¹æ—¥å…ƒçš„å®æ—¶æ±‡ç‡æ˜¾ç¤º

---

## âœ… ä»»åŠ¡ 1ï¼šä¼˜åŒ– MarketItem UI æ˜¾ç¤º

### ä¿®æ”¹æ–‡ä»¶
- `src/lib/components/common/MarketItem.svelte`

### æ ¸å¿ƒæ”¹è¿›

#### 1.1 ä¿®å¤æ ‡é¢˜é‡å¤é—®é¢˜

**é—®é¢˜**ï¼šä¹‹å‰å¯èƒ½åŒæ—¶æ˜¾ç¤º `name` å’Œ `symbol`ï¼Œå¯¼è‡´"ç¾å…ƒ/æ—¥å…ƒ"å‡ºç°ä¸¤æ¬¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
```svelte
<!-- ä¼˜å…ˆæ˜¾ç¤ºä¸­æ–‡åç§°ï¼Œé¿å…é‡å¤ -->
<div class="market-name">{item.name}</div>
<!-- åªåœ¨æ²¡æœ‰ä¸­æ–‡åç§°æˆ–æ˜ç¡®è¦æ±‚æ˜¾ç¤ºæ—¶æ‰æ˜¾ç¤º symbol -->
{#if showSymbol && item.symbol !== item.name}
  <div class="market-symbol">{item.symbol}</div>
{/if}
```

**æ•ˆæœ**ï¼š
- å¦‚æœ `symbol` å’Œ `name` ç›¸åŒï¼Œåªæ˜¾ç¤ºä¸€æ¬¡
- å¦‚æœä¸åŒï¼Œæ‰åŒæ—¶æ˜¾ç¤ºï¼ˆä¾‹å¦‚ï¼šè‚¡ç¥¨ä»£ç å’Œå…¬å¸åï¼‰

#### 1.2 æ·»åŠ ä¸­æ–‡è¾…åŠ©æ ‡ç­¾

**æ–°å¢æ ‡ç­¾**ï¼š
- **å½“å‰ä»·**ï¼šæ ‡è®°ä¸»ä»·æ ¼æ•°å€¼
- **æ¶¨è·Œé¢**ï¼šæ ‡è®°ç»å¯¹å˜åŒ–å€¼ï¼ˆ+/-é‡‘é¢ï¼‰
- **æ¶¨è·Œå¹…**ï¼šæ ‡è®°ç™¾åˆ†æ¯”å˜åŒ–

**æ ·å¼è®¾è®¡**ï¼š
- å­—ä½“å¤§å°ï¼š`0.5rem`ï¼ˆæå°ï¼Œä¸æŠ¢çœ¼ï¼‰
- é¢œè‰²ï¼š`var(--text-muted)` + `opacity: 0.7`ï¼ˆä½è°ƒç°è‰²ï¼‰
- ä½ç½®ï¼šåœ¨æ•°å€¼æ—è¾¹ï¼Œå½¢æˆæ ‡ç­¾-æ•°å€¼å¯¹

**ä»£ç ç¤ºä¾‹**ï¼š
```svelte
<div class="price-row">
  <span class="price-label">å½“å‰ä»·</span>
  <div class="market-price">{priceDisplay}</div>
</div>
<div class="change-row">
  <span class="change-label">æ¶¨è·Œé¢</span>
  <div class="market-change">{changeAmount}</div>
</div>
<div class="change-row">
  <span class="change-label">æ¶¨è·Œå¹…</span>
  <div class="market-change">{changeText}</div>
</div>
```

#### 1.3 æ–°å¢æ•°æ®è®¡ç®—

æ·»åŠ äº† `changeAmount` æ´¾ç”Ÿå˜é‡ï¼š
```typescript
const changeAmount = $derived(
  !isDataAvailable || isNaN(item.change)
    ? 'â€”'
    : `${item.change > 0 ? '+' : ''}${item.change.toFixed(2)}`
);
```

### è§†è§‰æ•ˆæœ

**ä¼˜åŒ–å‰**ï¼š
```
ç¾å…ƒ/æ—¥å…ƒ
USD/JPY
156.23
-0.23%
```

**ä¼˜åŒ–å**ï¼š
```
ç¾å…ƒ/æ—¥å…ƒ
å½“å‰ä»· 156.23
æ¶¨è·Œé¢ -0.36
æ¶¨è·Œå¹… -0.23%
```

---

## âœ… ä»»åŠ¡ 2ï¼šæ·»åŠ  CNY/JPY æ±‡ç‡

### ä¿®æ”¹æ–‡ä»¶
1. `src/lib/api/forex.ts` - åç«¯é€»è¾‘
2. `src/lib/components/panels/USDJPYPanel.svelte` - å‰ç«¯æ˜¾ç¤º

### æ ¸å¿ƒå®ç°

#### 2.1 æ™ºèƒ½å›é€€ç­–ç•¥

å®ç°äº†ä¸‰å±‚è·å–ç­–ç•¥ï¼š

**ç­–ç•¥ 1ï¼šç›´æ¥ä» Yahoo Finance è·å–**
```typescript
export async function fetchCNYJPY(): Promise<ForexRate | null> {
  try {
    // å°è¯•ç›´æ¥è·å– CNYJPY=X
    const url = 'https://query1.finance.yahoo.com/v8/finance/chart/CNYJPY=X';
    const response = await fetchWithProxy(url);
    // å¦‚æœæˆåŠŸï¼Œç›´æ¥è¿”å›
    if (response.ok && hasValidData(data)) {
      return directRate;
    }
  } catch (error) {
    // å¤±è´¥åˆ™è¿›å…¥å›é€€ç­–ç•¥
  }
}
```

**ç­–ç•¥ 2ï¼šä» USD/JPY å’Œ USD/CNY è®¡ç®—**
```typescript
export function calculateCNYJPY(
  usdJpy: ForexRate | null,
  usdCny: ForexRate | null
): ForexRate | null {
  if (!usdJpy || !usdCny || usdCny.rate === 0) {
    return null;
  }

  // è®¡ç®—å…¬å¼ï¼šCNY/JPY = USD/JPY / USD/CNY
  const cnyjpyRate = usdJpy.rate / usdCny.rate;

  // è®¡ç®—æ¶¨è·Œå¹…ï¼ˆç»„åˆç™¾åˆ†æ¯”å˜åŒ–ï¼‰
  const changePercent = jpyChangePercent - cnyChangePercent;

  return {
    symbol: 'CNY/JPY',
    rate: cnyjpyRate,
    change: calculatedChange,
    changePercent: changePercent,
    timestamp: Math.max(usdJpy.timestamp, usdCny.timestamp)
  };
}
```

**ç­–ç•¥ 3ï¼šè‡ªåŠ¨å›é€€**
```typescript
export async function fetchCNYJPY(
  usdJpy?: ForexRate | null,
  usdCny?: ForexRate | null
): Promise<ForexRate | null> {
  // å…ˆå°è¯•ç›´æ¥è·å–
  const directRate = await fetchFromYahoo();
  if (directRate) return directRate;

  // å¤±è´¥åˆ™è®¡ç®—
  logger.log('Forex API', 'Calculating CNY/JPY from USD rates');
  return calculateCNYJPY(usdJpy, usdCny);
}
```

#### 2.2 æ•°å­¦åŸç†

**æ±‡ç‡è½¬æ¢å…¬å¼**ï¼š
```
1 CNY = ? JPY

å·²çŸ¥ï¼š
- 1 USD = X JPY  (USD/JPY)
- 1 USD = Y CNY  (USD/CNY)

æ¨å¯¼ï¼š
- 1 CNY = (1/Y) USD
- 1 CNY = (1/Y) USD Ã— X JPY/USD
- 1 CNY = X/Y JPY

å› æ­¤ï¼šCNY/JPY = USD/JPY / USD/CNY
```

**ç¤ºä¾‹è®¡ç®—**ï¼š
```
USD/JPY = 156.23 (1ç¾å…ƒ = 156.23æ—¥å…ƒ)
USD/CNY = 7.24  (1ç¾å…ƒ = 7.24äººæ°‘å¸)

CNY/JPY = 156.23 / 7.24 = 21.58
(1äººæ°‘å¸ = 21.58æ—¥å…ƒ)
```

**æ¶¨è·Œå¹…è®¡ç®—**ï¼š
```
å¦‚æœ USD/JPY æ¶¨äº† 1%ï¼ŒUSD/CNY æ¶¨äº† 0.5%
åˆ™ CNY/JPY æ¶¨å¹… â‰ˆ 1% - 0.5% = 0.5%

é€»è¾‘ï¼š
- USD/JPY ä¸Šæ¶¨ â†’ æ—¥å…ƒè´¬å€¼ â†’ CNY/JPY ä¸Šæ¶¨
- USD/CNY ä¸Šæ¶¨ â†’ äººæ°‘å¸è´¬å€¼ â†’ CNY/JPY ä¸‹è·Œ
- ç»„åˆæ•ˆåº” = JPYå˜åŒ– - CNYå˜åŒ–
```

#### 2.3 å‰ç«¯å±•ç¤º

åœ¨ `USDJPYPanel.svelte` ä¸­æ–°å¢æ˜¾ç¤ºå—ï¼š

```svelte
<!-- CNY/JPY (æ–°å¢) -->
{#if cnyjpyRate}
  <div class="forex-item">
    <div class="forex-header">
      <div class="forex-symbol">CNY/JPY</div>
      <div class="forex-label">äººæ°‘å¸/æ—¥å…ƒ</div>
    </div>
    <div class="rate-main">
      <div class="rate-value">{formatRate(cnyjpyRate)}</div>
    </div>
    {#if cnyjpyRate.changePercent !== undefined}
      <div class="rate-change">
        <div class="change-value">{formatChangeValue(cnyjpyRate)}</div>
        <div class="change-percent">{formatChange(cnyjpyRate)}</div>
      </div>
    {/if}
  </div>
{/if}
```

#### 2.4 API è°ƒç”¨æµç¨‹

```
fetchForexRates()
â”œâ”€â”€ fetchUSDJPYWithFallback()
â”‚   â”œâ”€â”€ exchangerate-api.com (ä¸»è¦)
â”‚   â””â”€â”€ Yahoo Finance (å›é€€)
â”œâ”€â”€ fetchUSDCNYWithFallback()
â”‚   â”œâ”€â”€ exchangerate-api.com (ä¸»è¦)
â”‚   â””â”€â”€ Yahoo Finance (å›é€€)
â””â”€â”€ fetchCNYJPY(jpyRate, cnyRate)
    â”œâ”€â”€ Yahoo Finance CNYJPY=X (å°è¯•ç›´æ¥è·å–)
    â””â”€â”€ calculateCNYJPY() (è®¡ç®—å›é€€)
```

### æ•°æ®ç»“æ„

```typescript
interface ForexRate {
  symbol: string;        // ä¾‹å¦‚: 'CNY/JPY'
  rate: number;          // æ±‡ç‡: 21.58
  change?: number;       // æ¶¨è·Œé¢: +0.15
  changePercent?: number; // æ¶¨è·Œå¹…: +0.7%
  timestamp: number;     // æ›´æ–°æ—¶é—´æˆ³
}
```

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### æµ‹è¯• 1ï¼šMarketItem æ˜¾ç¤ºä¼˜åŒ–

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š`npm run dev`
2. æ‰“å¼€æµè§ˆå™¨ï¼ŒæŸ¥çœ‹ä»»æ„å¸‚åœºæ•°æ®é¢æ¿
3. ç¡®è®¤æ˜¾ç¤ºå†…å®¹ï¼š
   - âœ… æ ‡é¢˜ä¸é‡å¤ï¼ˆåªæ˜¾ç¤ºä¸­æ–‡åç§°ï¼‰
   - âœ… "å½“å‰ä»·"æ ‡ç­¾æ˜¾ç¤º
   - âœ… "æ¶¨è·Œé¢"æ ‡ç­¾æ˜¾ç¤ºï¼ˆå¦‚æœ‰æ•°æ®ï¼‰
   - âœ… "æ¶¨è·Œå¹…"æ ‡ç­¾æ˜¾ç¤º
   - âœ… æ ‡ç­¾ä¸ºç°è‰²å°å­—ï¼Œä¸æŠ¢çœ¼

### æµ‹è¯• 2ï¼šCNY/JPY æ±‡ç‡æ˜¾ç¤º

1. åœ¨æ±‡ç‡é¢æ¿ä¸­æŸ¥çœ‹ CNY/JPY
2. ç¡®è®¤æ˜¾ç¤ºå†…å®¹ï¼š
   - âœ… æ±‡ç‡æ•°å€¼æ­£ç¡®ï¼ˆçº¦ä¸º USD/JPY Ã· USD/CNYï¼‰
   - âœ… æ¶¨è·Œé¢å’Œæ¶¨è·Œå¹…æ˜¾ç¤º
   - âœ… æ›´æ–°æ—¶é—´æˆ³æ˜¾ç¤º

### æµ‹è¯• 3ï¼šè®¡ç®—å‡†ç¡®æ€§éªŒè¯

åœ¨æµè§ˆå™¨æ§åˆ¶å°éªŒè¯ï¼š
```javascript
// è·å–ä¸‰ä¸ªæ±‡ç‡
const usdJpy = 156.23;
const usdCny = 7.24;
const cnyJpy = 21.58; // æ˜¾ç¤ºçš„ CNY/JPY

// éªŒè¯è®¡ç®—
const calculated = usdJpy / usdCny; // 156.23 / 7.24 = 21.58
console.log('è®¡ç®—å‡†ç¡®æ€§:', Math.abs(calculated - cnyJpy) < 0.01 ? 'âœ…' : 'âŒ');
```

### æµ‹è¯• 4ï¼šå›é€€ç­–ç•¥æµ‹è¯•

åœ¨å¼€å‘è€…å·¥å…·ä¸­æ¨¡æ‹Ÿ API å¤±è´¥ï¼š
1. æ‰“å¼€ Network é¢æ¿
2. é˜»æ­¢ `CNYJPY=X` è¯·æ±‚
3. åˆ·æ–°é¡µé¢
4. ç¡®è®¤ CNY/JPY ä»ç„¶æ˜¾ç¤ºï¼ˆä½¿ç”¨è®¡ç®—å€¼ï¼‰
5. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼šåº”è¯¥æ˜¾ç¤º"Calculating CNY/JPY from USD rates"

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æµè§ˆå™¨å…¼å®¹æ€§
- âœ… Chrome 120+
- âœ… Firefox 120+
- âœ… Edge 120+
- âœ… Safari 17+

### æ€§èƒ½ä¼˜åŒ–
- **å¹¶å‘è¯·æ±‚**ï¼šUSD/JPY å’Œ USD/CNY å¹¶è¡Œè·å–
- **ç¼“å­˜æœºåˆ¶**ï¼šä½¿ç”¨ `fetchWithProxy` çš„å†…ç½®ç¼“å­˜
- **é˜²æŠ–åˆ·æ–°**ï¼šæ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
- **é”™è¯¯å¤„ç†**ï¼šä»»ä¸€æ±‡ç‡å¤±è´¥ä¸å½±å“å…¶ä»–æ±‡ç‡æ˜¾ç¤º

### é”™è¯¯å¤„ç†

1. **API ä¸å¯ç”¨**ï¼šæ˜¾ç¤º"â€”"å¹¶è®°å½•æ—¥å¿—
2. **è®¡ç®—å¤±è´¥**ï¼šè¿”å› `null`ï¼Œä¸æ˜¾ç¤ºè¯¥æ±‡ç‡
3. **æ•°æ®å¼‚å¸¸**ï¼šä½¿ç”¨ `isNaN` æ£€æŸ¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦
4. **ç½‘ç»œé”™è¯¯**ï¼šè‡ªåŠ¨å›é€€åˆ°å¤‡ç”¨ API

---

## ğŸ“ ä»£ç å˜æ›´æ‘˜è¦

### æ–°å¢åŠŸèƒ½
- âœ… MarketItem æ·»åŠ ä¸­æ–‡æ ‡ç­¾ï¼ˆå½“å‰ä»·ã€æ¶¨è·Œé¢ã€æ¶¨è·Œå¹…ï¼‰
- âœ… CNY/JPY æ±‡ç‡è®¡ç®—é€»è¾‘
- âœ… CNY/JPY ç›´æ¥è·å– + è®¡ç®—å›é€€ç­–ç•¥
- âœ… USDJPYPanel æ˜¾ç¤º CNY/JPY

### ä¿®å¤é—®é¢˜
- âœ… ä¿®å¤ MarketItem æ ‡é¢˜é‡å¤æ˜¾ç¤ºé—®é¢˜
- âœ… ä¿®å¤ symbol å’Œ name ç›¸åŒæ—¶çš„å†—ä½™æ˜¾ç¤º

### æ–‡ä»¶å˜æ›´
| æ–‡ä»¶ | ç±»å‹ | å˜æ›´å†…å®¹ |
|------|------|----------|
| `MarketItem.svelte` | ä¿®æ”¹ | UI ä¼˜åŒ–ï¼Œæ·»åŠ æ ‡ç­¾ |
| `forex.ts` | ä¿®æ”¹ | æ–°å¢ CNY/JPY è·å–å’Œè®¡ç®—é€»è¾‘ |
| `USDJPYPanel.svelte` | ä¿®æ”¹ | æ˜¾ç¤º CNY/JPY æ±‡ç‡ |

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### æœ¬åœ°æµ‹è¯•
```bash
npm run dev
```

### æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
npm run build
```

### æ¨é€åˆ° GitHub
```bash
git add .
git commit -m "feat: ä¼˜åŒ–å¸‚åœºæ•°æ®æ˜¾ç¤ºï¼Œæ·»åŠ  CNY/JPY æ±‡ç‡"
git push origin main
```

### éƒ¨ç½²åˆ° GitHub Pages
- GitHub Actions ä¼šè‡ªåŠ¨è§¦å‘æ„å»º
- çº¦ 2-5 åˆ†é’Ÿåç”Ÿæ•ˆ
- è®¿é—®ï¼šhttps://yangnan1987.github.io/situation-monitor/

---

## ğŸ¯ ç”¨æˆ·ä»·å€¼

1. **æ›´æ¸…æ™°çš„æ•°æ®å±•ç¤º**
   - ä¸­æ–‡æ ‡ç­¾é™ä½ç†è§£æˆæœ¬
   - æ ‡é¢˜ä¸é‡å¤ï¼Œç•Œé¢æ›´ç®€æ´

2. **æ›´å…¨é¢çš„æ±‡ç‡ä¿¡æ¯**
   - æ–°å¢ CNY/JPYï¼Œæ»¡è¶³äººæ°‘å¸-æ—¥å…ƒç›´æ¥æ¢ç®—éœ€æ±‚
   - æ™ºèƒ½å›é€€ç­–ç•¥ä¿è¯æ•°æ®å¯ç”¨æ€§

3. **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**
   - æ¶¨è·Œé¢ + æ¶¨è·Œå¹…åŒé‡å±•ç¤ºï¼Œä¿¡æ¯æ›´å®Œæ•´
   - ä½è°ƒçš„æ ‡ç­¾è®¾è®¡ï¼Œä¸å½±å“æ ¸å¿ƒæ•°æ®é˜…è¯»

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Yahoo Finance API](https://query1.finance.yahoo.com/v8/finance/chart/)
- [ExchangeRate-API](https://www.exchangerate-api.com/)
- [æ±‡ç‡è®¡ç®—å…¬å¼](https://en.wikipedia.org/wiki/Exchange_rate)

---

**æ›´æ–°å®Œæˆï¼** ğŸ‰

å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·éšæ—¶åé¦ˆã€‚
